<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¸ì˜ì  ì˜¤ë§ˆì¹´ì„¸ (CVS Omakase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=IBM+Plex+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --cvs-orange: #FF6B35;
            --cvs-blue: #004E98;
            --cvs-neon-purple: #9D4EDD;
        }
        body {
            background-color: #0f172a;
            font-family: 'Noto Sans KR', sans-serif;
            color: #f8fafc;
            padding-bottom: 80px;
        }
        .receipt-font {
            font-family: 'IBM Plex Mono', 'D2Coding', monospace;
        }
        .receipt {
            background: #fff;
            color: #333;
            position: relative;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.5));
        }
        .receipt::after {
            content: "";
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 100%;
            height: 10px;
            background: linear-gradient(-45deg, transparent 5px, #fff 5px), linear-gradient(45deg, transparent 5px, #fff 5px);
            background-size: 10px 10px;
        }
        .ad-placeholder {
            background: rgba(30, 41, 59, 0.5);
            border: 1px dashed #475569;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #94a3b8;
            margin: 15px 0;
            overflow: hidden;
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="max-w-md mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-purple-500">
                CVS OMAKASE
            </h1>
            <p class="text-gray-400 text-sm mt-1">ë§Œì›ìœ¼ë¡œ ì¦ê¸°ëŠ” ë¯¸ìŠë­, í¸ì˜ì  ì˜¤ë§ˆì¹´ì„¸</p>
        </header>

        <!-- Step 1: Brand Selection -->
        <div id="step-1" class="step-container">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                <span class="bg-orange-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
                ì–´ë”” í¸ì˜ì  ì•ì´ì•¼?
            </h2>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="selectBrand('GS25')" class="bg-slate-800 p-6 rounded-2xl border-2 border-transparent hover:border-blue-400 transition-all flex flex-col items-center gap-2">
                    <span class="text-2xl font-bold text-blue-400">GS25</span>
                </button>
                <button onclick="selectBrand('CU')" class="bg-slate-800 p-6 rounded-2xl border-2 border-transparent hover:border-green-400 transition-all flex flex-col items-center gap-2">
                    <span class="text-2xl font-bold text-green-500">CU</span>
                </button>
                <button onclick="selectBrand('7-Eleven')" class="bg-slate-800 p-6 rounded-2xl border-2 border-transparent hover:border-red-400 transition-all flex flex-col items-center gap-2">
                    <span class="text-2xl font-bold text-red-500">7-Eleven</span>
                </button>
                <button onclick="selectBrand('Emart24')" class="bg-slate-800 p-6 rounded-2xl border-2 border-transparent hover:border-yellow-400 transition-all flex flex-col items-center gap-2">
                    <span class="text-2xl font-bold text-yellow-500">Emart24</span>
                </button>
            </div>
        </div>

        <!-- Step 1.5: Budget Selection -->
        <div id="step-budget" class="step-container hidden">
            <button onclick="goToStep(1)" class="text-gray-500 text-sm mb-4">â† ë‹¤ì‹œ ë¸Œëœë“œ ì„ íƒ</button>
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                <span class="bg-orange-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
                ì˜ˆì‚°ì€ ì–¼ë§ˆì •ë„ ìˆì–´?
            </h2>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="selectBudget(3000)" class="bg-slate-800 p-4 rounded-xl font-bold hover:bg-orange-900/30 transition-all">â‚© 3,000</button>
                <button onclick="selectBudget(5000)" class="bg-slate-800 p-4 rounded-xl font-bold hover:bg-orange-900/30 transition-all">â‚© 5,000</button>
                <button onclick="selectBudget(7000)" class="bg-slate-800 p-4 rounded-xl font-bold hover:bg-orange-900/30 transition-all">â‚© 7,000</button>
                <button onclick="selectBudget(10000)" class="bg-slate-800 p-4 rounded-xl font-bold hover:bg-orange-900/30 transition-all">â‚© 10,000</button>
            </div>
        </div>

        <!-- Step 2: Mood Selection -->
        <div id="step-2" class="step-container hidden">
            <button onclick="goToStep('budget')" class="text-gray-500 text-sm mb-4">â† ë‹¤ì‹œ ì˜ˆì‚° ì„ íƒ</button>
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                <span class="bg-orange-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">3</span>
                ì§€ê¸ˆ ìƒíƒœê°€ ì–´ë•Œ?
            </h2>
            <div class="flex flex-col gap-3">
                <button onclick="generateOmakase('ìŠ¤íŠ¸ë ˆìŠ¤ ë§Œë•… (ë§µê³  ìê·¹ì ì¸ ê±°)')" class="w-full bg-slate-800 p-4 rounded-xl text-left hover:bg-red-900/30 transition-all flex items-center gap-4">
                    <span class="text-2xl">ğŸ”¥</span>
                    <div><p class="font-bold">ìŠ¤íŠ¸ë ˆìŠ¤ ë§Œë•…</p><p class="text-xs text-gray-400">ë§µê³  ìê·¹ì ì¸ ì¡°í•©</p></div>
                </button>
                <button onclick="generateOmakase('í‡´ê·¼ê¸¸ í˜¼ìˆ  (ì•ˆì£¼ í•„ìš”)')" class="w-full bg-slate-800 p-4 rounded-xl text-left hover:bg-blue-900/30 transition-all flex items-center gap-4">
                    <span class="text-2xl">ğŸº</span>
                    <div><p class="font-bold">í‡´ê·¼ê¸¸ í˜¼ìˆ </p><p class="text-xs text-gray-400">ê°“ì„±ë¹„ ì•ˆì£¼</p></div>
                </button>
            </div>
        </div>

        <!-- Step 3: Loading -->
        <div id="step-loading" class="step-container hidden py-20 text-center">
            <div class="relative inline-block">
                <div class="w-20 h-20 border-4 border-orange-500 border-t-transparent rounded-full animate-spin"></div>
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-2xl">ğŸª</div>
            </div>
            <p id="loading-text" class="mt-6 text-orange-400 font-bold animate-pulse">AI ì•Œë°”ìƒì´ ë©”ë‰´ ì§œëŠ” ì¤‘...</p>
        </div>

        <!-- Step 4: Result -->
        <div id="step-result" class="step-container hidden">
            <div id="receipt-container" class="receipt p-6 rounded-t-sm receipt-font shadow-2xl overflow-hidden mb-5">
                <div class="text-center border-b-2 border-dashed border-gray-300 pb-4 mb-4">
                    <p class="text-xs text-gray-500">*** CVS OMAKASE RECEIPT ***</p>
                    <h3 id="res-title" class="text-xl font-black mt-2">ì¶”ì²œ ë©”ë‰´</h3>
                    <p id="res-brand" class="text-sm">Store: -</p>
                </div>
                <div class="mb-4">
                    <div id="res-items" class="text-sm space-y-1"></div>
                    <div class="border-t border-gray-200 mt-2 pt-2 flex justify-between font-bold text-lg">
                        <span>TOTAL</span>
                        <span id="res-price">â‚© 0</span>
                    </div>
                </div>
                <div class="mb-4 pt-4 border-t-2 border-dashed border-gray-300">
                    <p class="text-[10px] text-gray-400 mb-2 font-bold uppercase underline">Cooking Recipe</p>
                    <div id="res-recipe" class="text-xs space-y-2 leading-relaxed"></div>
                </div>
                <div class="pt-4 border-t-2 border-dashed border-gray-300 text-center italic text-sm">
                    "<span id="res-comment">ë§›ìˆê²Œ ë“œì„¸ìš”!</span>"
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="goToStep(1)" class="flex-1 bg-slate-700 py-4 rounded-xl font-bold">ë‹¤ì‹œ í•˜ê¸°</button>
                <button id="save-to-favorites" class="flex-1 bg-orange-600 py-4 rounded-xl font-bold">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>

        <!-- Saved Tab -->
        <div class="mt-20">
            <h3 class="text-lg font-bold mb-4">ë‚˜ì˜ ì €ì¥í•¨ <span id="fav-count" class="text-sm font-normal text-gray-500">0</span></h3>
            <div id="favorites-list" class="space-y-4"></div>
        </div>
    </div>

    <!-- í•˜ë‹¨ ê³ ì • ê´‘ê³  ì˜ì—­ -->
    <div class="fixed bottom-0 left-0 w-full h-[60px] bg-slate-900 border-t border-slate-700 flex items-center justify-center z-50 overflow-hidden">
        <div class="ad-placeholder w-full h-full m-0 border-0">
            <p>ADVERTISEMENT</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ì„¤ì •
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cvs-omakase';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        /**
         * [ë³´ì•ˆ íŒ¨ì¹˜] í•˜ë“œì½”ë”©ëœ API Keyë¥¼ ì œê±°í–ˆìŠµë‹ˆë‹¤.
         * Vite ë“±ì˜ ë¹Œë“œ ë„êµ¬ë¥¼ ì‚¬ìš©í•œë‹¤ë©´ .env íŒŒì¼ì— VITE_GEMINI_API_KEYë¥¼ ì •ì˜í•˜ì„¸ìš”.
         * GitHub ë°°í¬ ì‹œì—ëŠ” ê° ë°°í¬ ì„œë¹„ìŠ¤(Vercel, Netlify ë“±)ì˜ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •ì— í‚¤ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.
         */
        const apiKey = (typeof import.meta !== 'undefined' && import.meta.env && import.meta.env.VITE_GEMINI_API_KEY) 
                        ? import.meta.env.VITE_GEMINI_API_KEY 
                        : ""; 

        let user = null;
        let currentBrand = '';
        let currentBudget = 3000;
        let currentResult = null;

        window.goToStep = (step) => {
            document.querySelectorAll('.step-container').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(isNaN(step) ? `step-${step}` : `step-${step}`);
            if (target) target.classList.remove('hidden');
        };

        window.selectBrand = (brand) => { currentBrand = brand; goToStep('budget'); };
        window.selectBudget = (budget) => { currentBudget = budget; goToStep(2); };

        async function fetchWithBackoff(url, options, retries = 5) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return await response.json();
                } catch (err) {
                    if (i === retries - 1) throw err;
                }
                const delay = Math.pow(2, i) * 1000;
                await new Promise(res => setTimeout(res, delay));
            }
        }

        window.generateOmakase = async (mood) => {
            if (!apiKey) {
                alert("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .env ì„¤ì •ì´ë‚˜ ë°°í¬ í™˜ê²½ ë³€ìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                goToStep(2);
                return;
            }
            
            goToStep('loading');
            
            const systemPrompt = `ë‹¹ì‹ ì€ í•œêµ­ í¸ì˜ì  ì „ë¬¸ê°€ 'ê¿€ì¡°í•© ë§ˆìŠ¤í„°'ì…ë‹ˆë‹¤. 
            ë¸Œëœë“œ: ${currentBrand}, ì˜ˆì‚°: ${currentBudget}ì› ì´ë‚´, ê¸°ë¶„: ${mood}ì— ë§ëŠ” ìƒí’ˆ ì¡°í•©ì„ ì¶”ì²œí•˜ì„¸ìš”.
            ë°˜ë“œì‹œ ì•„ë˜ JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”:
            { "combo_name": "String", "total_price_estimate": Number, "items": [{"name": "String", "price": Number}], "recipe_steps": ["String"], "ai_comment": "String" }`;

            try {
                const data = await fetchWithBackoff(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `ì¶”ì²œí•´ì¤˜: ${currentBrand}, ${currentBudget}ì›, ${mood}` }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                currentResult = result;
                displayResult(result);

            } catch (error) {
                console.error("Error:", error);
                alert("ì•Œë°”ìƒì´ ì§€ê¸ˆ ë°”ì˜ë„¤ìš”! API í‚¤ ìœ íš¨ì„±ì´ë‚˜ ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                goToStep(2);
            }
        };

        function displayResult(res) {
            document.getElementById('res-title').innerText = res.combo_name;
            document.getElementById('res-brand').innerText = `Store: ${currentBrand}`;
            document.getElementById('res-price').innerText = `â‚© ${res.total_price_estimate.toLocaleString()}`;
            document.getElementById('res-comment').innerText = res.ai_comment;
            document.getElementById('res-items').innerHTML = res.items.map(i => `<div class="flex justify-between"><span>- ${i.name}</span><span>${i.price.toLocaleString()}</span></div>`).join('');
            document.getElementById('res-recipe').innerHTML = res.recipe_steps.map((s,idx) => `<p>${idx+1}. ${s}</p>`).join('');
            goToStep('result');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, (u) => { if (u) { user = u; loadFavorites(); } });

        async function saveToFavorites() {
            if (!user || !currentResult) return;
            const favCol = collection(db, 'artifacts', appId, 'users', user.uid, 'favorites');
            await addDoc(favCol, { ...currentResult, store_brand: currentBrand, savedAt: Date.now() });
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }

        function loadFavorites() {
            if (!user) return;
            const favCol = collection(db, 'artifacts', appId, 'users', user.uid, 'favorites');
            onSnapshot(favCol, (snapshot) => {
                const list = document.getElementById('favorites-list');
                document.getElementById('fav-count').innerText = snapshot.size;
                list.innerHTML = snapshot.empty ? '<p class="text-gray-600 text-center py-5 text-sm">ì €ì¥ëœ ì¡°í•©ì´ ì—†ìŠµë‹ˆë‹¤.</p>' : '';
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const card = document.createElement('div');
                    card.className = 'bg-slate-800 p-4 rounded-xl flex justify-between items-center border-l-4 border-orange-500';
                    card.innerHTML = `<div><p class="font-bold text-sm">${data.combo_name}</p><p class="text-[10px] text-gray-400">${data.store_brand}</p></div>
                                      <div class="flex gap-2"><button class="v-btn text-xs bg-slate-700 px-3 py-1 rounded">ë³´ê¸°</button><button class="d-btn text-xs text-red-500">ì‚­ì œ</button></div>`;
                    list.appendChild(card);
                    card.querySelector('.v-btn').onclick = () => { currentBrand = data.store_brand; displayResult(data); };
                    card.querySelector('.d-btn').onclick = () => deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'favorites', docSnap.id));
                });
            }, (err) => console.error(err));
        }

        document.getElementById('save-to-favorites').onclick = saveToFavorites;
        initAuth();
    </script>
</body>
</html>